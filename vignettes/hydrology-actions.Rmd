---
title: "Hydrology actions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Hydrology actions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 6, fig.height =4)
```

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
library(R2Rscenario)
library(fallRunDSM)
library(DSMhabitat)
library(DSMflow)
```

This document provides additional information about how hydrology actions are implemented in the fall run model for Reorienting to Recovery (R2R). For more more information about the model itself, including the codebase, please see [our documentation](https://reorienting-to-recovery.github.io/fallRunDSM/).

The hydrology you select will determine the habitat inputs, as habitat input objects are generated by relating flow to suitable area. For more information, please see [the DSMhabitat documentation](https://reorienting-to-recovery.github.io/DSMhabitat/).

## Hydrology actions

There are 4 hydrology actions that can be implemented in the model. Each has an associated number that is used to build a scenario in the R2Rscenarios package.

* `22`: Use 2019 BiOp hydrology 
* `23`: Use EFF hydrology 
* `24`: Use HR&L hydrology
* `31`: Use HR&L + FF (dry years) hydrology

### 22: Use 2019 BiOp hydrology

If `22` is selected, all flow inputs to the model will be from the 2018-2019 Calsim II BiOp run. This is what is used in the baseline run.

### 23: Use functional flow hydrology

If `23` is selected, the Sacramento and San Joaquin river mainstem flow objects will use a synthetic hydrograph representing functional flows (FF) in the system. These hydrographs cover the 20-year model timeseries and were generated through rulesets that optimized salmonid survival based on the model logic. For rulesets, specific values, and logic, please see the [Sacramento FF documentation](https://reorienting-to-recovery.github.io/DSMflow/articles/EFF.html) and the [San Joaquin FF documentation](https://reorienting-to-recovery.github.io/DSMflow/articles/EFF_SJ.html). 

```{r, message = FALSE, warning = FALSE, echo = FALSE}
DSMflow::flows_cfs$eff_sac |> 
  filter(year(date) %in% 1980:2000) |> 
  select(date, `Upper Sacramento River`, `San Joaquin River`) |> 
  pivot_longer(`Upper Sacramento River`:`San Joaquin River`, 
               names_to = "watershed",
               values_to = "flow") |> 
  ggplot(aes(x = date, y = flow, color = watershed)) + 
  geom_line() +
  facet_wrap(~watershed, nrow = 2) +
  theme_bw() +
  theme(legend.position = "") +
  labs(x = "Model date",
       y = "Flow (cfs)",
       title = "Functional flows")
```

### 24: Use HR&L hydrology

If `24` is selected, the model will use a CalSim3 run that incorporates planned Habitat + Spring flow actions, which are expected in the near future, and proposed as part of the Healthy Rivers and Landscapes Program. However a scenario that reflects the Healthy Rivers and Landscapes proposal in full could not be accomplished in time for the October workshop, and is proposed for a future funding opportunity. This CalSim3 run is available at [CEQA](https://ceqanet.opr.ca.gov/2023060467/2). 


### 31: Use HR&L + FF (dry years) hydrology

If `31` is selected, the model will use a hydrology with the CalSim3 run from `24` as a base, and the FF hydrology from `23` for the San Joaquin and Sacramento Rivers. This hydrology implements FF only in model dry years (`1982`, `1986`, `1988-1993`, and `1995`). This has not been fully tested with habitat and will be iteratively improved. The plot below shows what this looks like for the San Joaquin and Sacramento Rivers; all other tributaries will be the same as flows from `24`.

```{r, message = FALSE, warning = FALSE, echo = FALSE}
DSMflow::flows_cfs$LTO_12a_eff_dy |> 
  filter(year(date) %in% 1980:2000) |> 
  select(date, `Upper Sacramento River`, `San Joaquin River`) |> 
  pivot_longer(`Upper Sacramento River`:`San Joaquin River`, 
               names_to = "watershed",
               values_to = "flow") |> 
  ggplot(aes(x = date, y = flow, color = watershed)) + 
  geom_line() +
  facet_wrap(~watershed, nrow = 2) +
  theme_bw() +
  theme(legend.position = "") +
  labs(x = "Model date",
       y = "Flow (cfs)",
       title = "CalSim3 + FF hydrology")
```